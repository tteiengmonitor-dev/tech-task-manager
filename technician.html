<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technician Panel</title>

<style>
:root{
    --bg1:#0f2027;
    --bg2:#203a43;
    --card:#1e2e34;
    --accent:#d4a373;
    --text:#f1f1f1;
    --border:#35565f;
}

body{
    margin:0;
    font-family:'Segoe UI',sans-serif;
    background:linear-gradient(135deg,var(--bg1),var(--bg2));
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
    padding:20px;
    color:var(--text);
}

.container{
    width:100%;
    max-width:800px;
    background:var(--card);
    padding:28px;
    border-radius:12px;
    box-shadow:0 8px 25px rgba(0,0,0,0.4);
}

.hidden{
  display:none;
}
    
h1{
    color:var(--accent);
    margin-top:0;
}

label{
    display:block;
    margin-top:14px;
    font-weight:600;
    font-size:13px;
}

input[type="text"],
input[type="password"]{
    width:100%;
    padding:8px;
    margin-top:5px;
    border-radius:8px;
    border:1px solid var(--border);
    background:#142328;
    color:var(--text);
    font-size:14px;
    box-sizing:border-box;
}

button{
    margin-top:10px;
    padding:8px 14px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-weight:600;
}

.primary{ background:var(--accent); color:#000; }
.start{ background:var(--accent); color:#000; }
.stop{ background:#f1c40f; color:#000; }
.complete{ background:#2ecc71; color:#000; }
.logout{ background:#444; color:#fff; }

.status{
    margin-top:15px;
    padding:12px;
    background:#142328;
    border-radius:10px;
    font-size:13px;
}
</style>
</head>
<body>

<div class="container">

    <h1 id="pageTitle">üîê Login</h1>
    
    <!-- LOGIN SECTION -->
    <div id="loginSection">
    
      <label>Employee ID</label>
      <input type="text" id="empId">
    
      <label>Password</label>
      <input type="password" id="password">
    
      <button class="primary" onclick="login()">Login</button>
    
    </div>
    
    <!-- WORK SECTION -->
    <div id="workSection" class="hidden">
    
      <button class="logout" onclick="logout()">Logout</button>
    
      <div class="status">
        Status: <b id="statusText">IDLE</b>
      </div>
      <h4 style="margin-top:20px;">üìä Daily Plan Timeline</h4>
        <div id="gantt" style="
          position:relative;
          height:80px;
          background:#142328;
          border-radius:10px;
          margin-bottom:20px;
          overflow:hidden;
        ">
        </div>
      <h3>Assigned Tasks</h3>
      <div id="taskList"></div>
    
      <button class="start" onclick="startTask()">START</button>
      <button class="stop" onclick="stopTask()">STOP</button>
      <button class="complete" onclick="completeTask()">COMPLETE</button>
    
    </div>

</div>

<script>

const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyYSSyAy8xQa5jINo-A7YHEPJY3DgRWeeB3C1lVmKwZKdgYJ-YESOP69CWCEmIrgBvmdQ/exec";

let currentEmpId = null;

/* ================= COOKIE HELPERS ================= */

function setCookie(name,value,days){
  const d = new Date();
  d.setTime(d.getTime()+(days*24*60*60*1000));
  document.cookie = name+"="+value+";expires="+d.toUTCString()+";path=/";
}

function getCookie(name){
  const value = "; "+document.cookie;
  const parts = value.split("; "+name+"=");
  if(parts.length === 2) return parts.pop().split(";").shift();
}

function deleteCookie(name){
  document.cookie = name+'=; Max-Age=-99999999;';
}

/* ================= AUTO LOGIN ================= */

window.onload = function(){
  const savedEmp = getCookie("empId");
  if(savedEmp){
    currentEmpId = savedEmp;
    showMain();
    loadTasks();

    setInterval(loadTasks, 30000); // üëà ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
  }
};

/* ================= LOGIN ================= */

function login(){

    fetch(WEBAPP_URL,{
      method:"POST",
      mode:"cors",
      headers:{
        "Content-Type":"application/json"
      },
      body:JSON.stringify({
        action:"logAction",
        empTaskId:empTaskId,
        taskAction:type
      })
    })
  .then(res=>res.json())
  .then(data=>{

    if(data.status==="success" && data.role==="technician"){

      currentEmpId = data.empId;
      setCookie("empId", data.empId, 30); // ‡∏à‡∏≥ 30 ‡∏ß‡∏±‡∏ô

      showMain();
      loadTasks();

    }else{
      alert("Login Failed");
    }

  });
}

function showMain(){
  document.getElementById("loginSection").classList.add("hidden");
  document.getElementById("workSection").classList.remove("hidden");
  document.getElementById("pageTitle").innerText = "üõ† Technician Panel";
}

/* ================= LOAD TASKS ================= */

function loadTasks(){

  fetch(`${WEBAPP_URL}?action=getTasks&empId=${currentEmpId}`)
  .then(res=>res.json())
  .then(data=>{

    const taskList=document.getElementById("taskList");
    taskList.innerHTML="";

    data.forEach(task=>{
    taskList.innerHTML+=`
      <div class="task-item" style="flex-direction:column;align-items:flex-start;margin-bottom:10px;">
        <div style="display:flex;align-items:flex-start;gap:8px;">
          <input type="radio" name="task" value="${task.empTaskId}">
          <div>
            <div style="font-weight:bold;font-size:15px;">
              ${task.taskId}
            </div>
            <div style="font-size:13px;opacity:0.9;">
              ${task.detail || ""}
            </div>
            <div style="font-size:12px;opacity:0.6;">
              Plan: ${task.planDuration} hr | ${task.status}
            </div>
          </div>
        </div>
      </div>
    `;
    });
drawGantt(data);
  });
}

/* ================= ACTIONS ================= */

function getSelectedTask(){
  const selected=document.querySelector('input[name="task"]:checked');
  if(!selected){
    alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å Task ‡∏Å‡πà‡∏≠‡∏ô");
    return null;
  }
  return selected.value;
}

function sendAction(type){

  const empTaskId=getSelectedTask();
  if(!empTaskId) return;

  fetch(WEBAPP_URL,{
  method:"POST",
  headers:{
    "Content-Type":"application/x-www-form-urlencoded"
  },
  body: new URLSearchParams({
    action:"logAction",
    empTaskId:empTaskId,
    taskAction:type
      })
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.error){
      alert(data.error);
    }else{
      document.getElementById("statusText").innerText=type;
      loadTasks();
    }
  });
}

function startTask(){ sendAction("START"); }
function stopTask(){ sendAction("STOP"); }
function completeTask(){

  if(!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô COMPLETE ?")) return;
  sendAction("COMPLETE");
}

function timeToMin(dateObj){
  return dateObj.getHours()*60 + dateObj.getMinutes();
}

function percentOfDay(min){
  const startDay = 8*60;   // 08:00
  const endDay   = 17*60;  // 17:00
  return ((min - startDay) / (endDay - startDay)) * 100;
}

function drawGantt(tasks){

  const gantt = document.getElementById("gantt");
  gantt.innerHTML = "";

  tasks.forEach(task=>{

    // üëá 1. ‡πÅ‡∏õ‡∏•‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡∏ô
    const start = new Date(task.planStart);
    const end   = new Date(task.planEnd);

    // üëá 2. ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢
    if(isNaN(start) || isNaN(end)) return;

    // üëá 3. ‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏ï‡πà‡∏≠
    const startMin = timeToMin(start);
    const endMin   = timeToMin(end);

    const left = percentOfDay(startMin);
    const width = percentOfDay(endMin) - left;

    // ===== PLAN BLOCK =====
    const planBlock = document.createElement("div");
    planBlock.style.position="absolute";
    planBlock.style.left = left + "%";
    planBlock.style.width = width + "%";
    planBlock.style.height="40px";
    planBlock.style.top="20px";
    planBlock.style.background="#d4a373";
    planBlock.style.borderRadius="6px";
    planBlock.style.opacity="0.4";

    gantt.appendChild(planBlock);

    // ===== SAFE RUNTIME BLOCK =====
    const actualMin = Number(task.actualMin) || 0;
    const planHour  = Number(task.planDuration) || 0;
    const planMin   = planHour * 60;

    if(planMin > 0 && actualMin > 0){

      const runtimeWidth = (actualMin / planMin) * width;

      const runBlock = document.createElement("div");
      runBlock.style.position="absolute";
      runBlock.style.left = left + "%";
      runBlock.style.width = runtimeWidth + "%";
      runBlock.style.height="40px";
      runBlock.style.top="20px";
      runBlock.style.background="#2ecc71";
      runBlock.style.borderRadius="6px";

      gantt.appendChild(runBlock);
    }

    // ===== LABEL =====
    const label = document.createElement("div");
    label.style.position="absolute";
    label.style.left = left + "%";
    label.style.width = width + "%";
    label.style.height="40px";
    label.style.top="20px";
    label.style.display="flex";
    label.style.alignItems="center";
    label.style.justifyContent="center";
    label.style.fontSize="11px";
    label.style.fontWeight="bold";
    label.style.color="#000";
    label.innerText = task.taskId;

    gantt.appendChild(label);

  });
}
    
/* ================= LOGOUT ================= */

function logout(){
  localStorage.removeItem("empId");
  document.getElementById("workSection").classList.add("hidden");
  document.getElementById("loginSection").classList.remove("hidden");
  document.getElementById("pageTitle").innerText = "üîê Login";
}

</script>
</body>

</html>









