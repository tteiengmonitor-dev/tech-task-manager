<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Technician Panel</title>

<style>
body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:#0f2027;
  color:#fff;
  display:flex;
  justify-content:center;
  padding:30px;
}
.container{
  width:100%;
  max-width:800px;
  background:#1e2e34;
  padding:25px;
  border-radius:15px;
}
input[type="text"],
input[type="password"]{
  width:100%;
  padding:10px;
  margin-bottom:10px;
  border-radius:8px;
  border:1px solid #35565f;
  background:#142328;
  color:#fff;
}
button{
  padding:10px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:bold;
  margin-top:8px;
}
.start{background:#d4a373;color:#000;}
.stop{background:#f1c40f;color:#000;}
.complete{background:#2ecc71;color:#000;}
.logout{background:#c44536;color:#fff;}
.task-item{
  display:flex;
  align-items:center;
  gap:8px;
}

.task-item input[type="radio"]{
  margin:0;
}

.task-item label{
  margin:0;
}

.status{
  margin-top:10px;
  padding:10px;
  background:#142328;
  border-radius:8px;
}
</style>
</head>
<body>

<div class="container">

<h2>ðŸ›  Technician Panel</h2>

<div id="loginBox">
  <input type="text" id="empId" placeholder="Employee ID">
  <input type="password" id="password" placeholder="Password">
  <button onclick="login()">Login</button>
</div>

<div id="mainBox" style="display:none;">
  <div class="status">
    Status: <b id="statusText">IDLE</b>
  </div>

  <div id="taskList"></div>

  <button class="start" onclick="startTask()">START</button>
  <button class="stop" onclick="stopTask()">STOP</button>
  <button class="complete" onclick="completeTask()">COMPLETE</button>
  <button class="logout" onclick="logout()">LOGOUT</button>
</div>

</div>

<script>

const WEBAPP_URL = "https://script.google.com/macros/s/AKfycbyYSSyAy8xQa5jINo-A7YHEPJY3DgRWeeB3C1lVmKwZKdgYJ-YESOP69CWCEmIrgBvmdQ/exec";

let currentEmpId = null;

/* ================= COOKIE HELPERS ================= */

function setCookie(name,value,days){
  const d = new Date();
  d.setTime(d.getTime()+(days*24*60*60*1000));
  document.cookie = name+"="+value+";expires="+d.toUTCString()+";path=/";
}

function getCookie(name){
  const value = "; "+document.cookie;
  const parts = value.split("; "+name+"=");
  if(parts.length === 2) return parts.pop().split(";").shift();
}

function deleteCookie(name){
  document.cookie = name+'=; Max-Age=-99999999;';
}

/* ================= AUTO LOGIN ================= */

window.onload = function(){
  const savedEmp = getCookie("empId");
  if(savedEmp){
    currentEmpId = savedEmp;
    showMain();
    loadTasks();
  }
};

/* ================= LOGIN ================= */

function login(){

  fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({
      action:"login",
      empId:document.getElementById("empId").value,
      password:document.getElementById("password").value
    })
  })
  .then(res=>res.json())
  .then(data=>{

    if(data.status==="success" && data.role==="technician"){

      currentEmpId = data.empId;
      setCookie("empId", data.empId, 30); // à¸ˆà¸³ 30 à¸§à¸±à¸™

      showMain();
      loadTasks();

    }else{
      alert("Login Failed");
    }

  });
}

function showMain(){
  document.getElementById("loginBox").style.display="none";
  document.getElementById("mainBox").style.display="block";
}

/* ================= LOAD TASKS ================= */

function loadTasks(){

  fetch(`${WEBAPP_URL}?action=getTasks&empId=${currentEmpId}`)
  .then(res=>res.json())
  .then(data=>{

    const taskList=document.getElementById("taskList");
    taskList.innerHTML="<h4>Assigned Tasks</h4>";

    data.forEach(task=>{
    taskList.innerHTML+=`
  <div class="task-item" style="flex-direction:column;align-items:flex-start;margin-bottom:10px;">
    <div style="display:flex;align-items:flex-start;gap:8px;">
      <input type="radio" name="task" value="${task.empTaskId}">
      <div>
        <div style="font-weight:bold;font-size:15px;">
          ${task.taskId}
        </div>
        <div style="font-size:13px;opacity:0.9;">
          ${task.detail || ""}
        </div>
        <div style="font-size:12px;opacity:0.6;">
          Plan: ${task.planDuration} hr | ${task.status}
        </div>
      </div>
    </div>
  </div>
`;
    });

  });
}

/* ================= ACTIONS ================= */

function getSelectedTask(){
  const selected=document.querySelector('input[name="task"]:checked');
  if(!selected){
    alert("à¹€à¸¥à¸·à¸­à¸ Task à¸à¹ˆà¸­à¸™");
    return null;
  }
  return selected.value;
}

function sendAction(type){

  const empTaskId=getSelectedTask();
  if(!empTaskId) return;

  fetch(WEBAPP_URL,{
    method:"POST",
    body:JSON.stringify({
    action:"logAction",
    empTaskId:empTaskId,
    taskAction:type
    })
  })
  .then(res=>res.json())
  .then(data=>{
    if(data.error){
      alert(data.error);
    }else{
      document.getElementById("statusText").innerText=type;
      loadTasks();
    }
  });
}

function startTask(){ sendAction("START"); }
function stopTask(){ sendAction("STOP"); }
function completeTask(){

  if(!confirm("à¸¢à¸·à¸™à¸¢à¸±à¸™ COMPLETE ?")) return;
  sendAction("COMPLETE");
}

/* ================= LOGOUT ================= */

function logout(){
  deleteCookie("empId");
  location.reload();
}

</script>
</body>
</html>